DROP TABLE ALQUILA;
DROP TABLE SOCIO;
DROP TABLE ACTUA;
DROP TABLE ACTORES;
DROP TABLE EJEMPLAR;
DROP TABLE PELICULA;
DROP TABLE DIRECTOR;


CREATE TABLE DIRECTOR (
NOMBRE VARCHAR2(20),
NACIONALIDAD VARCHAR2(20),
CONSTRAINT DIRECTOR_PK PRIMARY KEY (NOMBRE)
);

CREATE TABLE PELICULA (
ID VARCHAR2(4),
TITULO VARCHAR2(30) NOT NULL,
PRODUCTORA VARCHAR2(30),
NACIONALIDAD VARCHAR2(20),
FECHA DATE,
DIRECTOR VARCHAR2(20),
CONSTRAINT PELICULA_PK PRIMARY KEY (ID),
CONSTRAINT PELICULA_FK1 FOREIGN KEY (DIRECTOR) REFERENCES DIRECTOR(NOMBRE) 
);

CREATE TABLE EJEMPLAR (
ID_PELI VARCHAR2(4),
NUMERO	NUMBER(3),
ESTADO VARCHAR2(10),
CONSTRAINT EJEMPLAR_PK PRIMARY KEY (ID_PELI, NUMERO),
CONSTRAINT EJEMPLAR_FK1 FOREIGN KEY (ID_PELI) REFERENCES PELICULA(ID)
);

CREATE TABLE ACTORES (
NOMBRE VARCHAR2(20),
NACIONALIDAD VARCHAR2(15),
SEXO VARCHAR2(1),
CONSTRAINT ACTORES_PK PRIMARY KEY (NOMBRE),
CONSTRAINT ACTORES_CK CHECK (SEXO IN ('H', 'M'))
);

CREATE TABLE ACTUA (
ACTOR VARCHAR2(20),
ID_PELI VARCHAR2(4),
PROTA VARCHAR2(1) DEFAULT 'N',
CONSTRAINT ACTUA_PK PRIMARY KEY (ACTOR, ID_PELI),
CONSTRAINT ACTUA_FK1 FOREIGN KEY (ACTOR) REFERENCES ACTORES(NOMBRE),
CONSTRAINT ACTUA_FK2 FOREIGN KEY (ID_PELI) REFERENCES PELICULA(ID),
CONSTRAINT ACTUA_CK CHECK (PROTA IN ('S', 'N'))
);

CREATE TABLE SOCIO (
DNI VARCHAR2(9),
NOMBRE VARCHAR2(20) NOT NULL,
DIRECCION VARCHAR2(30),
TELEFONO VARCHAR2(10),
AVALADOR VARCHAR2(9),
CONSTRAINT SOCIO_PK PRIMARY KEY (DNI),
CONSTRAINT SOCIO_FK1 FOREIGN KEY (AVALADOR) REFERENCES SOCIO(DNI)
);

CREATE TABLE ALQUILA(
DNI VARCHAR2(9),
ID_PELI VARCHAR2(4),
NUMERO NUMBER(3),
FECHAALQUILER DATE,
FECHADEVOLUCION DATE,
CONSTRAINT ALQUILA_PK PRIMARY KEY (DNI, ID_PELI, NUMERO, FECHAALQUILER),
CONSTRAINT ALQUILA_FK1 FOREIGN KEY (DNI) REFERENCES SOCIO(DNI),
CONSTRAINT ALQUILA_FK2 FOREIGN KEY (ID_PELI, NUMERO) REFERENCES EJEMPLAR(ID_PELI, NUMERO),
CONSTRAINT ALQUILA_CK CHECK (FECHADEVOLUCION > FECHAALQUILER)
);

/*A*/
INSERT INTO DIRECTOR VALUES ('EMILIO', 'ESPAÑOLA');
INSERT INTO DIRECTOR VALUES ('JOSEFE', 'ARGENTINA');

INSERT INTO PELICULA VALUES ('A123', 'HASTA LUEGO', 'PELIFILM', 'ESPAÑOLA', '12-11-2020', 'EMILIO');
INSERT INTO PELICULA VALUES ('A124', 'BUENAS TARDES', 'FILMCN', 'ESPAÑOLA', '11-10-2020', 'JOSEFE');
INSERT INTO PELICULA VALUES ('B123', 'BUENOS DIAS', 'PELISNET', 'ITALIANA', '10-12-2020', 'EMILIO');
INSERT INTO PELICULA VALUES ('B124', 'COMO ESTAS', 'NETFLIX', 'ARGENTINA', '02-11-2019', 'JOSEFE');

INSERT INTO EJEMPLAR VALUES ('A123', 1, 'BUENO');
INSERT INTO EJEMPLAR VALUES ('A123', 2, 'BUENO');
INSERT INTO EJEMPLAR VALUES ('A124', 1, 'MALO');
INSERT INTO EJEMPLAR VALUES ('A124', 2, 'BUENO');
INSERT INTO EJEMPLAR VALUES ('B123', 1, 'REGULAR');
INSERT INTO EJEMPLAR VALUES ('B123', 2, 'BUENO');
INSERT INTO EJEMPLAR VALUES ('B124', 1, 'EXCELENTE');
INSERT INTO EJEMPLAR VALUES ('B124', 2, 'BUENO');

INSERT INTO SOCIO VALUES ('47512486B', 'JOAQUIN', 'CALLE BETIS 7', '680121233', NULL);
INSERT INTO SOCIO VALUES ('57589486Z', 'SANDRA', 'CALLE MURCIA 8', '777411254', '47512486B');
INSERT INTO SOCIO VALUES ('28542436Y', 'LAURA', 'CALLE SEGOVIA 7', '699403264', '57589486Z');
INSERT INTO SOCIO VALUES ('40112122Q', 'ESTEFANIA', 'CALLE CASTILLA 6', '687411254', '28542436Y');


INSERT INTO ACTORES VALUES ('CRISTINA', 'ESPAÑOLA', 'M');
INSERT INTO ACTORES VALUES ('RAFAEL', 'VENEZOLANO', 'H');
INSERT INTO ACTORES VALUES ('ADELA', 'FRANCESA', 'M');
INSERT INTO ACTORES VALUES ('FLAVIO', 'ITALIANA', 'H');
INSERT INTO ACTORES VALUES ('JAVIER', 'ESPAÑOLA', 'H');
INSERT INTO ACTORES VALUES ('FRANCISCO', 'CUBANA', 'H');

INSERT INTO ACTUA VALUES ('CRISTINA', 'A123', 'S');
INSERT INTO ACTUA VALUES ('FLAVIO', 'A124', 'S');
INSERT INTO ACTUA VALUES ('RAFAEL', 'B123', 'S');
INSERT INTO ACTUA VALUES ('ADELA', 'B124', 'S');

INSERT INTO ALQUILA VALUES ('47512486B', 'A123', 1, '10-01-2021', '15-01-2021');
INSERT INTO ALQUILA VALUES ('57589486Z', 'A123', 2, '02-02-2021', '05-02-2021');
INSERT INTO ALQUILA VALUES ('28542436Y', 'A124', 1, '13-01-2021', '16-01-2021');
INSERT INTO ALQUILA VALUES ('40112122Q', 'A124', 2, '14-01-2021', '18-01-2021');
INSERT INTO ALQUILA VALUES ('28542436Y', 'B123', 1, '01-02-2021', '04-02-2021');
INSERT INTO ALQUILA VALUES ('47512486B', 'B123', 2, '19-01-2021', '22-01-2021');
INSERT INTO ALQUILA VALUES ('47512486B', 'B124', 2, '22-01-2021', '26-01-2021');
INSERT INTO ALQUILA VALUES ('57589486Z', 'B124', 1, '09-02-2021', '12-02-2021');

/*B Nos da el fallo de que no se puede realizar una insrción NULL en la tabla SOCIO en el campo Nombre, e igual en película*/
INSERT INTO SOCIO VALUES ('47102286B', NULL, 'CALLE ROSAS 7', '790120102', NULL);
INSERT INTO PELICULA VALUES ('C123', NULL, 'PELIFILM', 'ITALIANA', '04-10-2020', 'EMILIO');

/*C Nos da error por violación de la ACTORES_CK que obliga a que el campo sea H o M*/
INSERT INTO ACTORES VALUES ('TEODORO', 'ESPAÑOLA', 'X');

/*D Funciona e inserta por defecto el valor N en el campo PROTA*/ 
INSERT INTO ACTUA (ACTOR, ID_PELI) VALUES ('JAVIER', 'A123');
SELECT * FROM ACTUA WHERE ACTOR = 'JAVIER';

/*E Da error  por violación de la restricción puesta en ALQUILA_CK*/
INSERT INTO ALQUILA VALUES ('40112122Q', 'B124', 1, '20-01-2021', '18-01-2021');

/*F*/
UPDATE DIRECTOR SET NACIONALIDAD = 'ESP' WHERE NACIONALIDAD ='ESPAÑOLA';
UPDATE DIRECTOR SET NACIONALIDAD = 'ARG' WHERE NACIONALIDAD ='ARGENTINA';

/*G*/
UPDATE ACTORES SET NACIONALIDAD = 'ESP' WHERE NACIONALIDAD = 'ESPAÑOLA';
UPDATE ACTORES SET NACIONALIDAD = 'VEN' WHERE NACIONALIDAD = 'VENEZOLANO';
UPDATE ACTORES SET NACIONALIDAD = 'FRA' WHERE NACIONALIDAD = 'FRANCESA';
UPDATE ACTORES SET NACIONALIDAD = 'CUB' WHERE NACIONALIDAD = 'CUBANA';
UPDATE ACTORES SET NACIONALIDAD = 'ITA' WHERE NACIONALIDAD = 'ITALIANA';

/*H*/
UPDATE SOCIO SET AVALADOR = '47512486B' WHERE DNI != '47512486B';

/*I La sentencia se ejecuta pero no hace nada porque no existe ningún socio con un número inferior a 5*/
DELETE FROM SOCIO WHERE TELEFONO < '5%';

/*J  No se puede borrar porque estos socios se encuentran referenciados en la tabla ALQUILA*/
DELETE FROM SOCIO WHERE TELEFONO = '5%' OR TELEFONO > '5%';

/*K Se podría solucionar si se hubiera utilizado la cláusula ON DELETE CASCADE a la hora de definir las FK*/

/*L No se puede borrar porque el campo director es una FK de la tabla pelicula*/
DELETE FROM DIRECTOR;

/*M No se puede borrar porque dicha pelicula está siendo referenciada en otra tabla, para ello habría que haberla definido en su FK como ON DELETE CASACADE*/
DELETE FROM PELICULA WHERE ID = 'A123';
DELETE FROM PELICULA WHERE ID = 'A124';
